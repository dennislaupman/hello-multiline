<!DOCTYPE html>
<html ng-app="helloMultiLine">
<head>
	<title>Hello... Realtime collaboration editor</title>

	<style type="text/css">

		body {
			margin: 0;
			padding: 0; 
		}

		[hello] {

			width: 550px;
			padding: 10px;
			box-sizing: border-box;
			font-family: verdana;
			font-size: 14px;
			line-height: 24px;
		}

		.line {

			height: 24px;
			overflow: hidden;
			position: relative;
		}


		.selection {

			height:24px;
			width: 0;
			background: #86be40;
			opacity: 0.35;
			position: absolute;
			z-index: 0;
			top:0;
		}

		.selection.blue {

			background: #54bed3;
		}

		.selection.pink {

			background: #f062a4;
		}

		.selection.yellow {

			background: #ffd33a;
		}

		
	</style>
</head>
<body  ng-controller="helloMultiLineCtrl">

	<div hello ng-click="selectRange()">

		<div>
			<div class="line" ng-repeat="line in lines">
				{{line.content}}
				<div 
				
					class="selection {{selection.color}}" 
					style="left:{{line.selection.left}}px; width:{{line.selection.width}};">
				</div>
			</div>
		</div>

	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
	<script src='/socket.io/socket.io.js'></script>

	<script type="text/javascript">

		var getRowNumbers = function (startContainer, endContainer) {

			var counter = 0, start =0, end = 0;
			var container = document.querySelector( '[hello] div' );

			for (var i = 0; i <container.childNodes.length; i++) {

				//Skipt text nodes
				if(container.childNodes[i].nodeType === 3 || container.childNodes[i].nodeType === 8) {

					continue;
				}

				//Get start line
				if( container.childNodes[i] == startContainer.parentNode ) {

					start = counter;
				}
				//Get end line
				if( container.childNodes[i] == endContainer.parentNode ) {

					end = counter;
				}

				counter++;
			};

			return { start: start, end: end };
		}

		var app = angular.module('helloMultiLine', [])
  			app.controller('helloMultiLineCtrl', function( $scope, $timeout ) {

  				$scope.lines = [
  					{ content: 'Lorem Ipsum is slechts een proeftekst uit het drukkerij- en ' },
  					{ content:'zetterijwezen. Lorem Ipsum is de standaard proeftekst in deze' },
  					{ content:'zethaak met letters nam en ze door elkaar husselde om een font-' },
					{ content:'catalogus te maken. Het heeft niet alleen vijf eeuwen overleefd maar is ' },
					{ content:'ook, vrijwel onveranderd, overgenomen in elektronische letterzetting. ' },
					{ content:'Het is in de jaren \'60 populair geworden met de introductie van Letraset ' },
					{ content:'vellen met Lorem Ipsum passages en meer recentelijk door desktop ' },
					{ content:'publishing software zoals Aldus PageMaker die versies van Lorem' },
					{ content:'Ipsum bevatten.' }	
  				];

  				//socket connection
  				$scope.connectedClients = [];

				var socketId =null
				var timers = [];


			   	var socket = io();
		            socket.on('connectedClients', function(data) {

						$scope.connectedClients = data.connectedClients;

    					$scope.$apply();

						console.log('connectedClients', $scope.connectedClients);
		            });


		             socket.on('getSocketId', function(data) {
		              
						socketId = data.socketId;

						console.log('getSocketId', socketId);
		            });

		            //Get selection
		            socket.on('getSelectionRange',  function(data) {

		            	 for (var i = $scope.connectedClients.length - 1; i >= 0; i--) {

		            	 	  if( $scope.connectedClients[i].socketId == data.socketId) {

			            	 	  	for (var ii = 0; ii < $scope.lines.length; ii++ ) {

			            	 	  		//Declarations
										$scope.lines[ii].selection = {};

										var startAt = parseInt(data.startLine, 10),
											endsAt = parseInt(data.endLine, 10);

			            	 	  		if( ii >= startAt && ii <= endsAt ) {


			            	 	  			$scope.lines[ii].selection.width = 100+'%';


			            	 	  		} else {

			            	 	  			$scope.lines[ii].selection.width = 0+'%';

			            	 	  		}
			            	 	  	};

		            	 	  	break;
		            	 	  }
		            	 }

		            	$scope.$apply();
		            });

  				
  				//Set selection
				$scope.selectRange = function( event ) {

					var selObj = window.getSelection();

					var startOffset = selObj.getRangeAt(0).startOffset;
					var endOffset = selObj.getRangeAt(0).endOffset;

					var startOffsetContainer = selObj.getRangeAt(0).startContainer;
					var endOffsetContainer = selObj.getRangeAt(0).endContainer;

					var lineNumbers = getRowNumbers(startOffsetContainer, endOffsetContainer);

					console.clear();
					console.log('set startLine', lineNumbers.start);
					console.log('set startOffset', startOffset);
					console.log('set endLine', lineNumbers.end);
					console.log('set endOffset', endOffset);

					socket.emit('setSelectionRange', {

					 	'color': 'green',
					 	'startLine': lineNumbers.start, 
						'startOffset': startOffset,
						'endLine': lineNumbers.end, 
						'endOffset': endOffset,
						'socketId' : socketId,
						'name' : $scope.name || 'Undefined'
					 });
					}

			});

	</script>

</body>
</html>